<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Virtual Dom 及 Diff 算法初探 | 追旅</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="

早在react时期虚拟DOM就开始进入大家的视野，react是jsx语法，但虚拟DOM并不是和jsx语法强绑定的关系，vue在2.0版本 ...">
    
    <link rel="preload" href="/chJouBlog/assets/css/0.styles.e386f8b7.css" as="style"><link rel="preload" href="/chJouBlog/assets/js/app.637ca0df.js" as="script"><link rel="preload" href="/chJouBlog/assets/js/14.08047fee.js" as="script"><link rel="preload" href="/chJouBlog/assets/js/3.be0a23e6.js" as="script"><link rel="preload" href="/chJouBlog/assets/js/8.6527695b.js" as="script"><link rel="prefetch" href="/chJouBlog/assets/js/10.ccc903ee.js"><link rel="prefetch" href="/chJouBlog/assets/js/11.113bd00f.js"><link rel="prefetch" href="/chJouBlog/assets/js/12.c7b819ff.js"><link rel="prefetch" href="/chJouBlog/assets/js/13.987282e3.js"><link rel="prefetch" href="/chJouBlog/assets/js/15.67449264.js"><link rel="prefetch" href="/chJouBlog/assets/js/16.2c1d384f.js"><link rel="prefetch" href="/chJouBlog/assets/js/17.65f66c36.js"><link rel="prefetch" href="/chJouBlog/assets/js/18.0bc97b03.js"><link rel="prefetch" href="/chJouBlog/assets/js/19.0580e76c.js"><link rel="prefetch" href="/chJouBlog/assets/js/20.95eeaf98.js"><link rel="prefetch" href="/chJouBlog/assets/js/21.bd4a19de.js"><link rel="prefetch" href="/chJouBlog/assets/js/22.9f3c83ab.js"><link rel="prefetch" href="/chJouBlog/assets/js/23.c1b49511.js"><link rel="prefetch" href="/chJouBlog/assets/js/24.041abde7.js"><link rel="prefetch" href="/chJouBlog/assets/js/25.385fa805.js"><link rel="prefetch" href="/chJouBlog/assets/js/26.c8cfce8d.js"><link rel="prefetch" href="/chJouBlog/assets/js/27.87e5e7a8.js"><link rel="prefetch" href="/chJouBlog/assets/js/28.a84cb340.js"><link rel="prefetch" href="/chJouBlog/assets/js/29.8db6ed7e.js"><link rel="prefetch" href="/chJouBlog/assets/js/30.00d96687.js"><link rel="prefetch" href="/chJouBlog/assets/js/31.3eeadbc2.js"><link rel="prefetch" href="/chJouBlog/assets/js/32.26cab367.js"><link rel="prefetch" href="/chJouBlog/assets/js/33.13efecb9.js"><link rel="prefetch" href="/chJouBlog/assets/js/34.5c53b0b7.js"><link rel="prefetch" href="/chJouBlog/assets/js/35.e38e3b31.js"><link rel="prefetch" href="/chJouBlog/assets/js/36.474ab5d1.js"><link rel="prefetch" href="/chJouBlog/assets/js/37.2595f469.js"><link rel="prefetch" href="/chJouBlog/assets/js/38.1c53e4d0.js"><link rel="prefetch" href="/chJouBlog/assets/js/39.ba98aab2.js"><link rel="prefetch" href="/chJouBlog/assets/js/4.104eeabc.js"><link rel="prefetch" href="/chJouBlog/assets/js/40.8ef98a47.js"><link rel="prefetch" href="/chJouBlog/assets/js/41.f100adb5.js"><link rel="prefetch" href="/chJouBlog/assets/js/42.abfb3eb9.js"><link rel="prefetch" href="/chJouBlog/assets/js/43.bf331c55.js"><link rel="prefetch" href="/chJouBlog/assets/js/44.25942854.js"><link rel="prefetch" href="/chJouBlog/assets/js/45.e716a95e.js"><link rel="prefetch" href="/chJouBlog/assets/js/46.780245fa.js"><link rel="prefetch" href="/chJouBlog/assets/js/47.aa2a446f.js"><link rel="prefetch" href="/chJouBlog/assets/js/48.55564a15.js"><link rel="prefetch" href="/chJouBlog/assets/js/49.cc17f3e5.js"><link rel="prefetch" href="/chJouBlog/assets/js/5.3f1a40d1.js"><link rel="prefetch" href="/chJouBlog/assets/js/50.dd00c9fe.js"><link rel="prefetch" href="/chJouBlog/assets/js/51.309837d2.js"><link rel="prefetch" href="/chJouBlog/assets/js/52.95c74877.js"><link rel="prefetch" href="/chJouBlog/assets/js/53.7127c8f2.js"><link rel="prefetch" href="/chJouBlog/assets/js/54.7ec42236.js"><link rel="prefetch" href="/chJouBlog/assets/js/55.8cb5e427.js"><link rel="prefetch" href="/chJouBlog/assets/js/56.307a4488.js"><link rel="prefetch" href="/chJouBlog/assets/js/57.55e63250.js"><link rel="prefetch" href="/chJouBlog/assets/js/58.31ad35f6.js"><link rel="prefetch" href="/chJouBlog/assets/js/59.32b3f003.js"><link rel="prefetch" href="/chJouBlog/assets/js/6.5d929397.js"><link rel="prefetch" href="/chJouBlog/assets/js/60.51b995dd.js"><link rel="prefetch" href="/chJouBlog/assets/js/61.885c3204.js"><link rel="prefetch" href="/chJouBlog/assets/js/62.1ba97633.js"><link rel="prefetch" href="/chJouBlog/assets/js/63.8756b95c.js"><link rel="prefetch" href="/chJouBlog/assets/js/7.3346f5ea.js"><link rel="prefetch" href="/chJouBlog/assets/js/9.6fb3d168.js"><link rel="prefetch" href="/chJouBlog/assets/js/vuejs-paginate.dad866b2.js">
    <link rel="stylesheet" href="/chJouBlog/assets/css/0.styles.e386f8b7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/chJouBlog/" class="nav-link home-link">追旅 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/chJouBlog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/chJouBlog/tag/" class="nav-link">Tags</a></li><li class="nav-item"><a href="/chJouBlog/author.html" class="nav-link">Author</a></li><li class="nav-item"><a href="/chJouBlog/log.html" class="nav-link">Log</a></li><li class="nav-item"><a href="https://github.com/xwei111/chJouBlog" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li><li class="nav-item"><a href="https://xwei111.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">XW-UI</a></li><li class="nav-item"><a href="https://ludd.link" target="_blank" rel="noopener noreferrer" class="nav-link external">Ludd</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/chJouBlog/" class="nav-link mobile-home-link">追旅 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/chJouBlog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/chJouBlog/tag/" class="nav-link">Tags</a></li><li class="mobile-nav-item"><a href="/chJouBlog/author.html" class="nav-link">Author</a></li><li class="mobile-nav-item"><a href="/chJouBlog/log.html" class="nav-link">Log</a></li><li class="mobile-nav-item"><a href="https://github.com/xwei111/chJouBlog" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li><li class="mobile-nav-item"><a href="https://xwei111.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">XW-UI</a></li><li class="mobile-nav-item"><a href="https://ludd.link" target="_blank" rel="noopener noreferrer" class="nav-link external">Ludd</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        Virtual Dom 及 Diff 算法初探
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">追旅</span> <span itemprop="address">   in 杭州滨江</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-07-29T00:00:00.000Z">
      Wed Jul 29 2020
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/chJouBlog/tag/Virtual Dom" data-v-42ccfcd5><span data-v-42ccfcd5>Virtual Dom</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/chJouBlog/tag/Diff" data-v-42ccfcd5><span data-v-42ccfcd5>Diff</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>早在react时期虚拟DOM就开始进入大家的视野，react是jsx语法，但虚拟DOM并不是和jsx语法强绑定的关系，vue在2.0版本的时候也引入了虚拟DOM，支持jsx和模板。那么虚拟DOM是什么，为什么主流的框架都使用它，它有哪些优点？</p> <h2 id="什么是虚拟dom"><a href="#什么是虚拟dom" class="header-anchor">#</a> 什么是虚拟DOM</h2> <p>虚拟DOM其实就是具有真实DOM标签、属性、嵌套结构的js树形数据，在对真实DOM操作前都会通过diff算法计算前后的改动，最后根据改动的js数据去一次性的修改DOM结构，以此解决传统js操作DOM带来的弊端</p> <h2 id="优点"><a href="#优点" class="header-anchor">#</a> 优点</h2> <ul><li>跨平台： 虚拟DOM是js树结构，不限于浏览器DOM，同样适用于安卓、ios、小程序</li> <li>高性能： 配合diff算法，减少js操作真实DOM带来的性能消耗</li></ul> <h2 id="实现虚拟dom"><a href="#实现虚拟dom" class="header-anchor">#</a> 实现虚拟DOM</h2> <p>实现一个简单的虚拟DOM，我们大概需要三部分：</p> <ul><li>element：创建虚拟DOM</li> <li>diff: 计算虚拟DOM的变化</li> <li>patch: 将虚拟DOM的变化更新到真实DOM中</li></ul> <h3 id="生成dom树"><a href="#生成dom树" class="header-anchor">#</a> 生成DOM树</h3> <p>新建element.js，创建一个<code>Element</code>类，<code>Element</code>是生成虚拟DOM树的关键</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @param tag dom标签
 * @param props dom属性
 * @param children 子节点
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 存储标签、属性、子节点</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> children
        <span class="token comment">// 节点唯一标识</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> props<span class="token punctuation">.</span>key
        <span class="token punctuation">}</span>
        <span class="token comment">// 添加子元素个数</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token parameter">children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        children <span class="token operator">&amp;&amp;</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果元素为节点，将子节点个数加上</span>
                count <span class="token operator">+=</span> e<span class="token punctuation">.</span>count
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 节点转化为字符串</span>
                children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> e <span class="token operator">+</span> <span class="token string">''</span>
            <span class="token punctuation">}</span>
            count<span class="token operator">++</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> count
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">createElement</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>新建index.html，代码如下：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Virtual Dom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./element.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'bbb'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'ccc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>打印<code>data</code>可以清晰的看到生成的js tree</p> <p><img src="data:image/png;base64,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" alt="An image"></p> <p>接着我们需要将这部分数据渲染为真实的DOM，为<code>Element</code>类添加<code>render</code>方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>
    <span class="token comment">// 添加到真实DOM中</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置属性</span>
        Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加子节点</span>
        children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token operator">=&gt;</span> el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token operator">?</span> e<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token keyword">return</span> el
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在index.html调用该方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> app <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
</code></pre></div><p>打印<code>app</code>及实际渲染效果：</p> <p><img src="data:image/png;base64,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" alt="An image"></p> <p>这就是一个简单的虚拟DOM生成及渲染到浏览器的过程</p> <h3 id="对比虚拟dom生成补丁"><a href="#对比虚拟dom生成补丁" class="header-anchor">#</a> 对比虚拟DOM生成补丁</h3> <p>在对真实DOM改动之前会对新老虚拟DOM树进行对比然后生成补丁，对于两棵树的完全比较，<code>diff</code>算法的时间复杂程度为<code>O(n^3)</code>，但虚拟DOM很少有夸层级移动，所以我们只对同层级的元素进行对比，这样时间复杂度就变为<code>O(n)</code>，在网上找了一张图可以清晰的反应DOM对比过程</p> <p><img src="/chJouBlog/assets/img/20200729virtualdom-3.b79ff8f6.png" alt="An image"></p> <p>整个DOM树对比时会先进行深度优先遍历，并为每个节点添加唯一标识，如下图（请叫我盗图专家😄😄😄）：</p> <p><img src="/chJouBlog/assets/img/20200729virtualdom-4.b16ba7fe.png" alt="An image"></p> <p>了解这些后我们可以分析补丁可能有如下几种情况</p> <ul><li>文本内容变化</li> <li>节点属性变化</li> <li>节点被替换了</li> <li>节点位置变了</li></ul> <p>如果节点位置变了，例如<code>p</code>、<code>span</code>、<code>a</code>顺序变为了<code>span</code>、<code>a</code>、<code>p</code>，如果按照同级顺序对比的话这些节点标签不一样将会被完全替换掉，这显然不是我们想要的，实际上只需要移动它们即可，这里借助<code>list-diff2</code>算法来帮助我们完成这一过程</p> <p>大概聊一下<code>list-diff2</code>的实现，<code>diff</code>算法需要三个参数<code>oldList</code>、<code>newList</code>、<code>key</code>，其中<code>key</code>是非必填的，首先会遍历一遍旧数据，拿到一组集合也就是<code>children</code>，<code>children</code>是新旧数据都存在的子集并按照在旧数据中的顺序排列，子集没有的时候在<code>children</code>中为<code>null</code>，<code>list-diff2</code>源码通过<code>children.slice(0)</code>拷贝一份<code>children</code>得到<code>simulateList</code>（这个还蛮有意思的），遍历<code>simulateList</code>将为<code>null</code>的元素去掉并在<code>moves</code>中加入移除的元素的<code>index</code>和<code>type</code>，<code>type</code>为0表示移除，<code>type</code>为1表示插入。最后在遍历<code>newList</code>和<code>simulateList</code>中的个元素的<code>value</code>和<code>key</code>比较最终（这里还是有一些逻辑的建议去看看源码）得到完整的<code>moves</code>。大概就是这个样子，建议去看一下源码，加上注释空格也才100多行代码</p> <p>经过一系列分析，下载<a href="https://github.com/livoras/list-diff/blob/master/lib/diff.js" target="_blank" rel="noopener noreferrer">list-diff<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>并在index.html中引入，然后新建consts.js，添加如下常量</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">REPLACE</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 替换节点</span>
<span class="token keyword">const</span> <span class="token constant">REORDER</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// 插入节点</span>
<span class="token keyword">const</span> <span class="token constant">PROPS</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// 修改属性</span>
<span class="token keyword">const</span> <span class="token constant">TEXT</span> <span class="token operator">=</span> <span class="token number">3</span> <span class="token comment">// 文本改变</span>
</code></pre></div><p>新建diff.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">diff</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">oldData<span class="token punctuation">,</span> newData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 记录节点标识</span>
    <span class="token keyword">let</span> patches <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 记录各个节点变化(补丁)</span>
    <span class="token function">diffRun</span><span class="token punctuation">(</span>oldData<span class="token punctuation">,</span> newData<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> patches<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">diffRun</span><span class="token punctuation">(</span><span class="token parameter">oldNode<span class="token punctuation">,</span> newNode<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> currentPatch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 记录当前节点的补丁</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> oldNode <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> newNode <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 文本不同，添加文本变化补丁</span>
        oldNode <span class="token operator">!==</span> newNode <span class="token operator">&amp;&amp;</span> currentPatch<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> content<span class="token operator">:</span> newNode <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newNode <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> oldNode<span class="token punctuation">.</span>tag <span class="token operator">===</span> newNode<span class="token punctuation">.</span>tag <span class="token operator">&amp;&amp;</span> oldNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 节点相同，比较属性</span>
        <span class="token keyword">const</span> propsPatches <span class="token operator">=</span> <span class="token function">diffProps</span><span class="token punctuation">(</span>oldNode<span class="token punctuation">,</span> newNode<span class="token punctuation">)</span>
        <span class="token comment">// 属性存在差异，为节点添加属性变化补丁</span>
        propsPatches <span class="token operator">&amp;&amp;</span> currentPatch<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">PROPS</span><span class="token punctuation">,</span> props<span class="token operator">:</span> propsPatches <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 比较子节点</span>
        <span class="token function">diffChildren</span><span class="token punctuation">(</span>
            oldNode<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
            newNode<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
            index<span class="token punctuation">,</span>
            patches<span class="token punctuation">,</span>
            currentPatch
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newNode <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 节点不同且节点存在，为节点添加替换补丁</span>
        currentPatch<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">REPLACE</span><span class="token punctuation">,</span> node<span class="token operator">:</span> newNode <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPatch<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当前节点存在补丁，记录到对应标识位</span>
        patches<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> currentPatch
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 新旧属性比较</span>
<span class="token keyword">function</span> <span class="token function">diffProps</span><span class="token punctuation">(</span><span class="token parameter">oldNode<span class="token punctuation">,</span> newNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> isHave <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> propsPatch <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> newProps <span class="token operator">=</span> newNode<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">const</span> oldProps <span class="token operator">=</span> oldNode<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token comment">// 遍历旧属性，如有新属性值不同的记录下来</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newProps<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">!==</span> oldProps<span class="token punctuation">[</span>e<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            propsPatch<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">=</span> newProps<span class="token punctuation">[</span>e<span class="token punctuation">]</span>
            isHave <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 遍历新属性，如旧属性没有新属性记录下来</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>newProps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldProps<span class="token punctuation">[</span>e<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            propsPatch<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">=</span> newProps<span class="token punctuation">[</span>e<span class="token punctuation">]</span>
            isHave <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isHave <span class="token operator">!==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> propsPatch
<span class="token punctuation">}</span>
<span class="token comment">// 子节点比较</span>
<span class="token keyword">function</span> <span class="token function">diffChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChildren<span class="token punctuation">,</span> newChildren<span class="token punctuation">,</span> index<span class="token punctuation">,</span> patches<span class="token punctuation">,</span> currentPatch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// listdiff2 为list-diff2 算法，该算法的时间复杂度 O(n*m)</span>
    <span class="token comment">// diffs.children 是新DOM树中含有的旧DOM树的数据，没有则为null</span>
    <span class="token comment">// diffs.moves 是旧DOM各个节点的相应变动及新DOM中新增的节点的变动</span>
    <span class="token comment">// 后续附上list-diff2源码分析</span>
    <span class="token keyword">var</span> diffs <span class="token operator">=</span> <span class="token function">listdiff2</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">,</span> newChildren<span class="token punctuation">,</span> <span class="token string">'key'</span><span class="token punctuation">)</span>
    newChildren <span class="token operator">=</span> diffs<span class="token punctuation">.</span>children <span class="token comment">// 旧DOM树中未删除的节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>diffs<span class="token punctuation">.</span>moves<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// moves存在子集，添加替换补丁</span>
        <span class="token keyword">var</span> reorderPatch <span class="token operator">=</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">REORDER</span><span class="token punctuation">,</span> moves<span class="token operator">:</span> diffs<span class="token punctuation">.</span>moves <span class="token punctuation">}</span>
        currentPatch<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>reorderPatch<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> leftNode <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">var</span> currentNodeIndex <span class="token operator">=</span> index
    <span class="token comment">// 深度遍历子节点</span>
    oldChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> newChild <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        currentNodeIndex <span class="token operator">=</span> <span class="token punctuation">(</span>leftNode <span class="token operator">&amp;&amp;</span> leftNode<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
            <span class="token operator">?</span> currentNodeIndex <span class="token operator">+</span> leftNode<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token operator">:</span> currentNodeIndex <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token function">diffRun</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> newChild<span class="token punctuation">,</span> currentNodeIndex<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
        leftNode <span class="token operator">=</span> child
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码已经做了大量的注释，思路基本按照上述分析，我们就不在做过多的解释，将consts.js和diff.js引入index.html，尝试打补丁看一下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> oldData <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'ul'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token comment">// 标识  ul: 0</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//  li: 1    aaa: 2</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'bbb'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// li: 3    bbb: 4</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'ccc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//  li: 5    ccc: 6</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> newData <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'ul'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'bbb'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'ccc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> patches <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>oldData<span class="token punctuation">,</span> newData<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'patches----------'</span><span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
</code></pre></div><p><img src="data:image/png;base64,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" alt="An image"></p> <p>根据<code>patches</code>结果，我们可以看出相应标识节点发生的变化，再来看一组数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> oldData <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'ul'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'bbb'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'ccc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> newData <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'ul'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'bbb'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'ccc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> patches <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>oldData<span class="token punctuation">,</span> newData<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'patches----------'</span><span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
</code></pre></div><p><img src="data:image/png;base64,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" alt="An image"></p> <p>这组数据的补丁似乎有所不同，原因是我们为节点加上了唯一标识<code>key</code>，此时<code>list-diff2</code>可以精确的追踪到每个节点的变化，而上个例子<code>li</code>具体有没有换过位置等一系列操作是无法追踪到的，另外从补丁可以看出添加<code>key</code>后对DOM的更新效率更高一点</p> <p>到这里是不是可以想到<code>vue</code>为什么数组遍历的时候一定要加上<code>key</code>值了吗，因为对于动态DOM依赖<code>key</code>去追踪这些DOM的变化，并保证高效率的更新</p> <h3 id="打补丁"><a href="#打补丁" class="header-anchor">#</a> 打补丁</h3> <p>我们已经有了两次DOM树的补丁，那接下来就需要把补丁更新到真实DOM中去，新建patch.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">patch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> patches</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> walker <span class="token operator">=</span> <span class="token punctuation">{</span>index<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span> <span class="token comment">// 记录索引</span>
    <span class="token function">patchRun</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> patches<span class="token punctuation">,</span> walker<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">patchRun</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> patches<span class="token punctuation">,</span> walker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> currentPatches <span class="token operator">=</span> patches<span class="token punctuation">[</span>walker<span class="token punctuation">.</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> len <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes <span class="token operator">?</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 深度遍历子节点</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        walker<span class="token punctuation">.</span>index<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">patchRun</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> patches<span class="token punctuation">,</span> walker<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 存在补丁，及更新</span>
    currentPatches <span class="token operator">&amp;&amp;</span> <span class="token function">applyPatch</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> currentPatches<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">applyPatch</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> currentPatches</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentPatches<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">currentPatch</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>currentPatch<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">REPLACE</span><span class="token operator">:</span>
                <span class="token keyword">const</span> newNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> currentPatch<span class="token punctuation">.</span>node <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span>
                    <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>currentPatch<span class="token punctuation">.</span>node<span class="token punctuation">)</span>
                    <span class="token operator">:</span> currentPatch<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                node<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newNode<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">REORDER</span><span class="token operator">:</span>
                <span class="token function">reorderChildren</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> currentPatch<span class="token punctuation">.</span>moves<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">PROPS</span><span class="token operator">:</span>
                <span class="token function">setProps</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> currentPatch<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TEXT</span><span class="token operator">:</span>
                node<span class="token punctuation">.</span>textContent <span class="token operator">=</span> currentPatch<span class="token punctuation">.</span>content
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Unknown patch type '</span> <span class="token operator">+</span> currentPatch<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在index.html引入patch.js，最终index.html如下</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token name">doctype</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Virtual Dom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./listdiff2.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>./consts.js<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./element.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>./diff.js<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>./patch.js<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>patch<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Patch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> oldData <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'ul'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'bbb'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'ccc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> newData <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'ul'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'bbb'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'ccc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> oldData<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token keyword">const</span> patchel <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'patch'</span><span class="token punctuation">)</span>
    patchel<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newData<span class="token punctuation">)</span> <span class="token keyword">return</span>
        <span class="token keyword">const</span> patches <span class="token operator">=</span> <span class="token function">diff</span><span class="token punctuation">(</span>oldData<span class="token punctuation">,</span> newData<span class="token punctuation">)</span>
        <span class="token function">patch</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> patches<span class="token punctuation">)</span>
        newData <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>到此，已经粗略的了解了虚拟DOM</p> <h2 id="结语"><a href="#结语" class="header-anchor">#</a> 结语</h2> <p>充实自我，加油 ！！！</p> <p><a href="https://github.com/xwei111/virtual-dom-demo" target="_blank" rel="noopener noreferrer">完整代码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://chasejourney.top/virtual-dom-demo/" target="_blank" rel="noopener noreferrer">演示地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>参考： <a href="https://juejin.im/post/5d36cc575188257aea108a74#heading-6" target="_blank" rel="noopener noreferrer">深入剖析：Vue核心之虚拟DOM<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#前言" title="前言">前言</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#什么是虚拟dom" title="什么是虚拟DOM">什么是虚拟DOM</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#优点" title="优点">优点</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#实现虚拟dom" title="实现虚拟DOM">实现虚拟DOM</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#生成dom树" title="生成DOM树">生成DOM树</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#对比虚拟dom生成补丁" title="对比虚拟DOM生成补丁">对比虚拟DOM生成补丁</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#打补丁" title="打补丁">打补丁</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#结语" title="结语">结语</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/xwei111/chJouBlog" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li><li class="contact-item" data-v-3d9deeb8><a href="mailto:17681828640@163.com" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail" data-v-3d9deeb8><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-3d9deeb8></path><polyline points="22,6 12,13 2,6" data-v-3d9deeb8></polyline></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8>追旅 © 2020</li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/chJouBlog/assets/js/app.637ca0df.js" defer></script><script src="/chJouBlog/assets/js/14.08047fee.js" defer></script><script src="/chJouBlog/assets/js/3.be0a23e6.js" defer></script><script src="/chJouBlog/assets/js/8.6527695b.js" defer></script>
  </body>
</html>
