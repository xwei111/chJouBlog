<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>uniapp嵌入h5辛励过程 | 追旅</title>
    <meta name="generator" content="VuePress 1.9.8">
    
    <meta name="description" content="

最近需要在原
 ...">
    
    <link rel="preload" href="/chJouBlog/assets/css/0.styles.9c41d4b1.css" as="style"><link rel="preload" href="/chJouBlog/assets/js/app.e0a1053b.js" as="script"><link rel="preload" href="/chJouBlog/assets/js/18.44effaec.js" as="script"><link rel="preload" href="/chJouBlog/assets/js/3.b04752a2.js" as="script"><link rel="preload" href="/chJouBlog/assets/js/95.fc30d953.js" as="script"><link rel="prefetch" href="/chJouBlog/assets/js/10.a41222d9.js"><link rel="prefetch" href="/chJouBlog/assets/js/100.0d19dd9d.js"><link rel="prefetch" href="/chJouBlog/assets/js/101.5eb05c22.js"><link rel="prefetch" href="/chJouBlog/assets/js/102.b1913694.js"><link rel="prefetch" href="/chJouBlog/assets/js/11.fa0d851a.js"><link rel="prefetch" href="/chJouBlog/assets/js/12.b89788b0.js"><link rel="prefetch" href="/chJouBlog/assets/js/13.09ad3639.js"><link rel="prefetch" href="/chJouBlog/assets/js/14.457ac369.js"><link rel="prefetch" href="/chJouBlog/assets/js/15.6ef71ef1.js"><link rel="prefetch" href="/chJouBlog/assets/js/16.eaa6d3a9.js"><link rel="prefetch" href="/chJouBlog/assets/js/17.e9f7fae3.js"><link rel="prefetch" href="/chJouBlog/assets/js/19.5fbc4b23.js"><link rel="prefetch" href="/chJouBlog/assets/js/20.cd7c2a5d.js"><link rel="prefetch" href="/chJouBlog/assets/js/21.366f5740.js"><link rel="prefetch" href="/chJouBlog/assets/js/22.fb975796.js"><link rel="prefetch" href="/chJouBlog/assets/js/23.a649699b.js"><link rel="prefetch" href="/chJouBlog/assets/js/24.b7403a84.js"><link rel="prefetch" href="/chJouBlog/assets/js/25.e27c1513.js"><link rel="prefetch" href="/chJouBlog/assets/js/26.843e45fe.js"><link rel="prefetch" href="/chJouBlog/assets/js/27.14926dfc.js"><link rel="prefetch" href="/chJouBlog/assets/js/28.45aa8192.js"><link rel="prefetch" href="/chJouBlog/assets/js/29.024d728b.js"><link rel="prefetch" href="/chJouBlog/assets/js/30.b5f81add.js"><link rel="prefetch" href="/chJouBlog/assets/js/31.7fed7009.js"><link rel="prefetch" href="/chJouBlog/assets/js/32.9bbfb034.js"><link rel="prefetch" href="/chJouBlog/assets/js/33.45f193c9.js"><link rel="prefetch" href="/chJouBlog/assets/js/34.1ba64dfa.js"><link rel="prefetch" href="/chJouBlog/assets/js/35.945bd605.js"><link rel="prefetch" href="/chJouBlog/assets/js/36.0018fc29.js"><link rel="prefetch" href="/chJouBlog/assets/js/37.ebd501d1.js"><link rel="prefetch" href="/chJouBlog/assets/js/38.1fb9fc2a.js"><link rel="prefetch" href="/chJouBlog/assets/js/39.f9246a1e.js"><link rel="prefetch" href="/chJouBlog/assets/js/4.47dff7bf.js"><link rel="prefetch" href="/chJouBlog/assets/js/40.2ca4d299.js"><link rel="prefetch" href="/chJouBlog/assets/js/41.90d9c425.js"><link rel="prefetch" href="/chJouBlog/assets/js/42.c53408e5.js"><link rel="prefetch" href="/chJouBlog/assets/js/43.d7340dba.js"><link rel="prefetch" href="/chJouBlog/assets/js/44.926045d7.js"><link rel="prefetch" href="/chJouBlog/assets/js/45.123be3ce.js"><link rel="prefetch" href="/chJouBlog/assets/js/46.8d61cd3b.js"><link rel="prefetch" href="/chJouBlog/assets/js/47.a99d2384.js"><link rel="prefetch" href="/chJouBlog/assets/js/48.dfa337b8.js"><link rel="prefetch" href="/chJouBlog/assets/js/49.e50477b0.js"><link rel="prefetch" href="/chJouBlog/assets/js/5.8ce30c1a.js"><link rel="prefetch" href="/chJouBlog/assets/js/50.69d1d0b0.js"><link rel="prefetch" href="/chJouBlog/assets/js/51.2fc9c6db.js"><link rel="prefetch" href="/chJouBlog/assets/js/52.7429f981.js"><link rel="prefetch" href="/chJouBlog/assets/js/53.0f6231c1.js"><link rel="prefetch" href="/chJouBlog/assets/js/54.c80b9603.js"><link rel="prefetch" href="/chJouBlog/assets/js/55.e3c2c130.js"><link rel="prefetch" href="/chJouBlog/assets/js/56.21e7725e.js"><link rel="prefetch" href="/chJouBlog/assets/js/57.4a6db4ff.js"><link rel="prefetch" href="/chJouBlog/assets/js/58.f0b9b6bc.js"><link rel="prefetch" href="/chJouBlog/assets/js/59.d5193966.js"><link rel="prefetch" href="/chJouBlog/assets/js/6.01c50d34.js"><link rel="prefetch" href="/chJouBlog/assets/js/60.6e618d95.js"><link rel="prefetch" href="/chJouBlog/assets/js/61.78bfa8c5.js"><link rel="prefetch" href="/chJouBlog/assets/js/62.a3d39b4b.js"><link rel="prefetch" href="/chJouBlog/assets/js/63.6f8d732e.js"><link rel="prefetch" href="/chJouBlog/assets/js/64.d0a65735.js"><link rel="prefetch" href="/chJouBlog/assets/js/65.32b6eeb3.js"><link rel="prefetch" href="/chJouBlog/assets/js/66.6cc38b95.js"><link rel="prefetch" href="/chJouBlog/assets/js/67.763c6215.js"><link rel="prefetch" href="/chJouBlog/assets/js/68.0cb0daad.js"><link rel="prefetch" href="/chJouBlog/assets/js/69.ca3375f6.js"><link rel="prefetch" href="/chJouBlog/assets/js/7.efd827c5.js"><link rel="prefetch" href="/chJouBlog/assets/js/70.47756354.js"><link rel="prefetch" href="/chJouBlog/assets/js/71.046503a0.js"><link rel="prefetch" href="/chJouBlog/assets/js/72.5a25b9a2.js"><link rel="prefetch" href="/chJouBlog/assets/js/73.29a63373.js"><link rel="prefetch" href="/chJouBlog/assets/js/74.a3363646.js"><link rel="prefetch" href="/chJouBlog/assets/js/75.8fdb3e0e.js"><link rel="prefetch" href="/chJouBlog/assets/js/76.11527a6e.js"><link rel="prefetch" href="/chJouBlog/assets/js/77.44726f6c.js"><link rel="prefetch" href="/chJouBlog/assets/js/78.9834be37.js"><link rel="prefetch" href="/chJouBlog/assets/js/79.05b2648a.js"><link rel="prefetch" href="/chJouBlog/assets/js/8.043e02f0.js"><link rel="prefetch" href="/chJouBlog/assets/js/80.2491fe2e.js"><link rel="prefetch" href="/chJouBlog/assets/js/81.3cf213ae.js"><link rel="prefetch" href="/chJouBlog/assets/js/82.89329c0e.js"><link rel="prefetch" href="/chJouBlog/assets/js/83.8d491f50.js"><link rel="prefetch" href="/chJouBlog/assets/js/84.5238c3d5.js"><link rel="prefetch" href="/chJouBlog/assets/js/85.f6e25471.js"><link rel="prefetch" href="/chJouBlog/assets/js/86.dd4641cc.js"><link rel="prefetch" href="/chJouBlog/assets/js/87.2461de4c.js"><link rel="prefetch" href="/chJouBlog/assets/js/88.02c71a32.js"><link rel="prefetch" href="/chJouBlog/assets/js/89.28a73873.js"><link rel="prefetch" href="/chJouBlog/assets/js/9.1f794dd8.js"><link rel="prefetch" href="/chJouBlog/assets/js/90.44435622.js"><link rel="prefetch" href="/chJouBlog/assets/js/91.3cad974b.js"><link rel="prefetch" href="/chJouBlog/assets/js/92.4dee1481.js"><link rel="prefetch" href="/chJouBlog/assets/js/93.d408aaf5.js"><link rel="prefetch" href="/chJouBlog/assets/js/94.0298289c.js"><link rel="prefetch" href="/chJouBlog/assets/js/96.7503c18e.js"><link rel="prefetch" href="/chJouBlog/assets/js/97.f1d865a1.js"><link rel="prefetch" href="/chJouBlog/assets/js/98.2807ec5c.js"><link rel="prefetch" href="/chJouBlog/assets/js/99.69db6505.js"><link rel="prefetch" href="/chJouBlog/assets/js/vuejs-paginate.e039b1f5.js">
    <link rel="stylesheet" href="/chJouBlog/assets/css/0.styles.9c41d4b1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/chJouBlog/" class="nav-link home-link">追旅 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/chJouBlog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/chJouBlog/tag/" class="nav-link">Tags</a></li><li class="nav-item"><a href="/chJouBlog/author.html" class="nav-link">Author</a></li><li class="nav-item"><a href="/chJouBlog/log.html" class="nav-link">Log</a></li><li class="nav-item"><a href="https://github.com/xwei111/chJouBlog" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li><li class="nav-item"><a href="https://xwei111.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">XW-UI</a></li><li class="nav-item"><a href="https://ludd.link" target="_blank" rel="noopener noreferrer" class="nav-link external">Ludd</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/chJouBlog/" class="nav-link mobile-home-link">追旅 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/chJouBlog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/chJouBlog/tag/" class="nav-link">Tags</a></li><li class="mobile-nav-item"><a href="/chJouBlog/author.html" class="nav-link">Author</a></li><li class="mobile-nav-item"><a href="/chJouBlog/log.html" class="nav-link">Log</a></li><li class="mobile-nav-item"><a href="https://github.com/xwei111/chJouBlog" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li><li class="mobile-nav-item"><a href="https://xwei111.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">XW-UI</a></li><li class="mobile-nav-item"><a href="https://ludd.link" target="_blank" rel="noopener noreferrer" class="nav-link external">Ludd</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        uniapp嵌入h5辛励过程
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">追旅</span> <span itemprop="address">   in 杭州滨江</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2022-07-28T00:00:00.000Z">
      Thu Jul 28 2022
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/chJouBlog/tag/uniapp" data-v-42ccfcd5><span data-v-42ccfcd5>uniapp</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/chJouBlog/tag/h5" data-v-42ccfcd5><span data-v-42ccfcd5>h5</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/chJouBlog/tag/webview" data-v-42ccfcd5><span data-v-42ccfcd5>webview</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>最近需要在原<code>uniapp</code>开发的<code>app</code>中嵌入<code>h5</code>页面，过程遇到了非常多的问题，很有必要记录一下</p> <h2 id="按需引入vant"><a href="#按需引入vant" class="header-anchor">#</a> 按需引入vant</h2> <p>因为技术栈使用的是<code>vue3</code>，所以使用<code>unplugin-vue-components</code>完成按需引入，配置如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vue.config.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@vue/cli-service&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> VantResolver <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;unplugin-vue-components/resolvers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Components <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;unplugin-vue-components/webpack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">configureWebpack</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token function">Components</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">resolvers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">VantResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol><li>在使用组件时直接使用即可无需引入</li> <li>消息类<code>Toast</code>、<code>Dialog</code>等组件<code>unplugin-vue-components</code>无法自动引入对应样式需手动引入</li></ol> <h2 id="适配"><a href="#适配" class="header-anchor">#</a> 适配</h2> <p>适配采用<code>postcss-px-to-viewport</code>，设计稿基准是<code>750</code>，所以配置时需将<code>viewportWidth</code>设置为<code>750</code>，但<code>vant</code>组件的基准是<code>375</code>，所以适配需要对<code>vant</code>进行兼容（2022了再手动计算就不合适了），所以适配如下</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> file <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> designWidth <span class="token operator">=</span>
    file<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;node_modules&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;vant&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">375</span> <span class="token operator">:</span> <span class="token number">750</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;postcss-px-to-viewport&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">viewportWidth</span><span class="token operator">:</span> designWidth<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="vue3"><a href="#vue3" class="header-anchor">#</a> vue3</h2> <ul><li>模板</li></ul> <p><code>vue3</code>允许开发时模板不必被最外层元素包裹，但此种组件使用时无法添加<code>class</code>等属性</p> <ul><li>路由</li></ul> <p>匹配不到路由时配置更新为</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">&quot;/:pathMatch(.*)*&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;NotFound&quot;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;@/views/notFound&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>base</code>配置取消，通过<code>createWebHistory</code>传入</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">history</span><span class="token operator">:</span> <span class="token function">createWebHistory</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">BASE_URL</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  routes<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="hooks"><a href="#hooks" class="header-anchor">#</a> hooks</h2> <p><code>qjd-ui-hooks</code>已无法直接在<code>vue3</code>项目中直接使用，原因是找不到<code>@vue/composition-api</code>，原项目使用的<code>hooks</code>并非完全适用于<code>vue3</code></p> <h2 id="app跳转h5"><a href="#app跳转h5" class="header-anchor">#</a> app跳转h5</h2> <p>旧报告跳转后调用接口是免登录接口，由于无安全考虑方案被废弃，新报告需要考虑登录态，目前做的较为简单，通过中转页面在<code>h5</code>设置<code>cookie</code>，成功后后续接口携带<code>cookie</code>即<code>token</code>信息访问即可存在登录态 &amp; 登录时效</p> <p>方案一：</p> <ol><li>前端<code>app</code>调用后端接口获取<code>shortKey</code></li> <li><code>webview</code>页面嵌入服务端接口地址，<code>shortKey</code>传给服务端</li> <li>服务端拿到<code>shortKey</code>后置换真正的<code>token</code></li> <li>获取到<code>token</code>后将其设置在<code>h5</code>部署域名下</li></ol> <p>结果：</p> <ol><li>本地可以完成跳转，测试地址浏览器可以看到<code>cookie</code></li> <li>后续真机测试时，<code>webview</code>指向地址需为真实页面地址，此方案放弃</li></ol> <p>方案二：</p> <ol><li><code>webview</code>页面嵌入<code>h5</code>页面地址</li> <li>跳转<code>webview</code>前调用后端接口获取<code>shortKey</code></li> <li>获取<code>shortKey</code>后调用置换<code>token</code>接口，并在服务端设置<code>cookie</code></li> <li>置换<code>token</code>接口成功后跳转<code>webview</code></li></ol> <p>结果：</p> <p><code>cookie</code>表现混乱，时有时无，怀疑和跨域有关，此方案放弃</p> <p>方案三：</p> <ol><li><code>webview</code>页面嵌入<code>h5</code>页面地址</li> <li>获取<code>shortKey</code>后将跳转<code>webview</code></li> <li>将<code>shortKey</code>等参数带给<code>h5</code>页面</li> <li>在<code>h5</code>中转页面调用置换<code>token</code>接口，由服务端在此域名下设置<code>cookie</code></li> <li>在<code>h5</code>中转页面根据其他参数决定跳转哪个页面</li> <li>在页面请求接口若<code>cookie</code>已经失效，则跳转无权限页面</li> <li>由于页面层级深一层层返回体验较差，在无权限页面提供返回按钮，直接会到<code>app</code></li></ol> <p>结果：</p> <ol><li>真机表现较为正常，偶现<code>cookie</code>失效情况，需优化</li> <li><code>app</code>有接口轮询，会在<code>cookie</code>即将过期时更新<code>cookie</code>，则导致<code>h5</code>cookie过期时，回到<code>app</code>时<code>app</code>登录时效依然ok，表现不一，需优化</li> <li>后续微信消息跳转报告时此套逻辑不在适用，要走微信授权登录，需重新开发</li></ol> <h2 id="h5向uni通信"><a href="#h5向uni通信" class="header-anchor">#</a> h5向uni通信</h2> <p>由于需在无权限页提供一键返回按钮，需要<code>h5</code>向<code>uniapp</code>发送消息，<code>uniapp</code>文档不明朗，有误导倾向</p> <ul><li>误区一</li></ul> <p>文档中<code>@meaasge</code>的表述如下：</p> <p><code>H5 暂不支持（可以直接使用 window.postMessage (opens new window)）</code></p> <p>此处<code>H5</code>指的是<code>uniapp</code>打包为<code>H5</code>，并非指在<code>webview</code>中嵌入的<code>h5</code>页面，所以在<code>webview</code>中嵌入的<code>h5</code>页面向<code>uniapp</code>发送消息时仍调用<code>uni.postMessage</code>而非<code>window.postMessage</code></p> <ul><li>误区二</li></ul> <p>文档中关于<code>demo</code>部分调用了如下方法</p> <div class="language-js extra-class"><pre class="language-js"><code>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'UniAppJSBridgeReady'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>此方法是监听<code>uni</code>是否已经注入，但此方法应是在初始化时调用，而对于更深层次的调用时无需使用该方法监听，可以直接使用<code>uni</code>或者初始化时调用该方法后注册一个全局变量，后续使用即可</p> <p>综上，完成<code>h5向uni通信</code>如下：</p> <ol><li>引入<code>uni</code></li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 有条件可以将资源down下来放在本地 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/@dcloudio/uni-webview-js@0.0.3/index.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="2"><li>调用<code>uni</code></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 返回</span>
<span class="token keyword">const</span> <span class="token function-variable function">backHandle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  uni <span class="token operator">&amp;&amp;</span> uni<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;back&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="uni分享pdf"><a href="#uni分享pdf" class="header-anchor">#</a> uni分享pdf</h2> <p><code>uniapp</code>提供几种分享方式，大致两种</p> <ol><li>调用社区<code>sdk</code></li> <li>调用手机自带分享</li></ol> <p><code>uniapp</code>集成的<code>sdk</code>目前支持<code>微信、QQ、微博</code>，这远不够目前要求的平台，如：钉钉、企业微信等平台需要自行实现，插件市场倒是可以找到插件，但是数量都只有一个，不但收费，而且质量、版本无保障，退而求其次，选择手机自带的分享功能</p> <ul><li>安卓</li></ul> <p>文档解释安卓高版本无法分享图片，若是携带图片，则默认为图片类型，此种效果不是我们想要的</p> <ul><li>ios</li></ul> <p>强！！！</p> <p>结论：</p> <ol><li>采用手机自带分享功能</li> <li>分享时区分<code>ios</code>和<code>安卓</code>，<code>ios</code>分享携带图片，<code>安卓</code>分享只有文案和链接</li></ol> <p>注： 分享出去的效果由机型确定，所以在测试华为分享微信时是真的丑</p> <h2 id="分享链接"><a href="#分享链接" class="header-anchor">#</a> 分享链接</h2> <p>原采用<code>pc</code>端<code>pdf</code>下载链接，但是由于<code>content-type</code>是错误的导致在钉钉上打开乱码，所以采用新的链接</p> <p>新链接具备时效性，目前时效为<code>1</code>天，此链接具备一定安全性</p> <h2 id="ios安全区"><a href="#ios安全区" class="header-anchor">#</a> ios安全区</h2> <p>对于新的<code>ios</code>手机如：iphone11、iphone12、iphonex等机型都有底部安全区，也就是底部白色区域，处理方案是添加<code>viewport-fit=cover</code></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>在<code>h5</code>上是没有什么问题的，基本可以解决问题，但是在<code>uni</code>中，表现不尽如人意，经过尝试去掉</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">body</span> <span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>后，凡是撑开<code>body</code>产生滚动条的页面不会产生底部白条，而其余页面偶现，暂无更好方案处理</p> <p>样式变化后带来后续的滚动计算方式</p> <h2 id="ios齐刘海、底部黑条"><a href="#ios齐刘海、底部黑条" class="header-anchor">#</a> ios齐刘海、底部黑条</h2> <p>完整样式如下，没有此样式，底部区域会被黑条覆盖</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token atrule"><span class="token rule">@supports</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token property">height</span><span class="token punctuation">:</span> <span class="token function">constant</span><span class="token punctuation">(</span>safe-area-inset-top<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token property">height</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-top<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token property">-webkit-overflow-scrolling</span><span class="token punctuation">:</span> touch<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">body</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 适配齐刘海 */</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> <span class="token function">constant</span><span class="token punctuation">(</span>safe-area-inset-top<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">padding-top</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-top<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 适配底部小黑条 */</span>
    <span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">costant</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="iphonex兼容"><a href="#iphonex兼容" class="header-anchor">#</a> iphonex兼容</h2> <p>图片写了宽度后，高度会自适应，但是在<code>iphonex</code>机型下不写高度会出现图片拉长情况</p> <h2 id="特性环境测试问题"><a href="#特性环境测试问题" class="header-anchor">#</a> 特性环境测试问题</h2> <p><code>pc</code>端服务端通过不同请求头拉取不同资源，移动端真机测试无法设置</p> <p><code>uniapp</code>真机模式提供了<code>useragent</code>配置，可以添加多余信息，配置如下</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;app-plus&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;useragent&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(#test#)&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;concatenate&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 开启concatenate在原useragent上添加信息</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;useragent_android&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(#test#)&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;concatenate&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;useragent_ios&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(#test#)&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;concatenate&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此种方式为静态配置，经测试服务端可以拿到配置的额外配置的<code>(#test#)</code>数据</p> <p>可以后续改进方案通过<code>setUserAgent</code>动态设置<code>useragent</code>，如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> userAgent <span class="token operator">=</span> plus<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span><span class="token function">getUserAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
plus<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span><span class="token function">setUserAgent</span><span class="token punctuation">(</span>userAgent <span class="token operator">+</span> <span class="token string">'(#test#)'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="结语"><a href="#结语" class="header-anchor">#</a> 结语</h2> <p>移动端问题真心多</p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#前言" title="前言">前言</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#按需引入vant" title="按需引入vant">按需引入vant</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#适配" title="适配">适配</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#vue3" title="vue3">vue3</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#hooks" title="hooks">hooks</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#app跳转h5" title="app跳转h5">app跳转h5</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#h5向uni通信" title="h5向uni通信">h5向uni通信</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#uni分享pdf" title="uni分享pdf">uni分享pdf</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#分享链接" title="分享链接">分享链接</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#ios安全区" title="ios安全区">ios安全区</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#ios齐刘海、底部黑条" title="ios齐刘海、底部黑条">ios齐刘海、底部黑条</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#iphonex兼容" title="iphonex兼容">iphonex兼容</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#特性环境测试问题" title="特性环境测试问题">特性环境测试问题</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#结语" title="结语">结语</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/xwei111/chJouBlog" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li><li class="contact-item" data-v-3d9deeb8><a href="mailto:17681828640@163.com" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail" data-v-3d9deeb8><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-3d9deeb8></path><polyline points="22,6 12,13 2,6" data-v-3d9deeb8></polyline></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8>追旅 © 2020</li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/chJouBlog/assets/js/app.e0a1053b.js" defer></script><script src="/chJouBlog/assets/js/18.44effaec.js" defer></script><script src="/chJouBlog/assets/js/3.b04752a2.js" defer></script><script src="/chJouBlog/assets/js/95.fc30d953.js" defer></script>
  </body>
</html>
